<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Good Evening!</title>
        <link rel="stylesheet" href="style.css">
        <link rel="shortcut icon" href="/img/icon.png" type="image/x-icon">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>

    <body>
        <header>
            <img src="/img/logo-round.png" class="logo">
            <h1>WinterEvening.</h1>
        </header>

        <main>
            <div class="connection-container">
                <input id="peerId" type="text" placeholder="Enter peer ID">
                <button id="connectButton">Connect</button>
            </div>

            <div class="chat-container" id="chatContainer">
                <!-- Messages will appear here -->
            </div>

            <div class="input-container">
                <input id="messageInput" type="text" placeholder="Type a message" disabled>
                <button id="sendMessageButton" disabled>Send</button>
            </div>
        </main>

        <footer id="footer">
            <div class="main">

            </div>
            <p>Â© WinterEvening 2024-2025</p>
        </footer>

        <script>
            let localConnection;
            let remoteConnection;
            let sendChannel;
            let receiveChannel;

            const connectButton = document.getElementById('connectButton');
            const peerIdInput = document.getElementById('peerId');
            const messageInput = document.getElementById('messageInput');
            const sendMessageButton = document.getElementById('sendMessageButton');
            const chatContainer = document.getElementById('chatContainer');

            function addMessage(content, type) {
                const messageElement = document.createElement('div');
                messageElement.className = `chat-message ${type}`;
                messageElement.textContent = content;
                chatContainer.appendChild(messageElement);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            connectButton.addEventListener('click', () => {
                // Initialize the connection
                localConnection = new RTCPeerConnection();

                // Create a data channel
                sendChannel = localConnection.createDataChannel('chat');
                sendChannel.onmessage = (event) => {
                    addMessage(event.data, 'received');
                };

                sendChannel.onopen = () => {
                    messageInput.disabled = false;
                    sendMessageButton.disabled = false;
                };

                sendChannel.onclose = () => {
                    messageInput.disabled = true;
                    sendMessageButton.disabled = true;
                };

                // Set up the remote connection
                remoteConnection = new RTCPeerConnection();

                remoteConnection.ondatachannel = (event) => {
                    receiveChannel = event.channel;
                    receiveChannel.onmessage = (event) => {
                        addMessage(event.data, 'received');
                    };
                };

                // Exchange offer and answer
                localConnection.createOffer().then((offer) => {
                    return localConnection.setLocalDescription(offer);
                }).then(() => {
                    return remoteConnection.setRemoteDescription(localConnection.localDescription);
                }).then(() => {
                    return remoteConnection.createAnswer();
                }).then((answer) => {
                    return remoteConnection.setLocalDescription(answer);
                }).then(() => {
                    return localConnection.setRemoteDescription(remoteConnection.localDescription);
                });
            });

            sendMessageButton.addEventListener('click', () => {
                const message = messageInput.value;
                if (message) {
                    addMessage(message, 'sent');
                    sendChannel.send(message);
                    messageInput.value = '';
                }
            });
        </script>

    </body>
</html>
